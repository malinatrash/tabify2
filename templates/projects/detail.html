{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Project Header -->
        <div class="col-12 mb-4">
            <div class="vision-glass-card fade-in">
                <!-- Top section with title and controls -->
                <div class="project-header-content">
                    <div class="project-title-section">
                        <h1 class="project-title">{{ project.title }}</h1>
                        <div class="project-author">
                            <i class="fas fa-user-edit"></i>
                            <span>Created by <a href="/users/profile/{{ project.owner.id }}">{{ project.owner.full_name
                                    }}</a></span>
                            <span class="project-date"><i class="far fa-calendar-alt"></i> {{
                                project.created_at.strftime('%B %d, %Y') }}</span>
                        </div>
                    </div>

                    <!-- Project controls section -->
                    <div class="project-controls">
                        <!-- Tempo control -->
                        <div class="control-item project-tempo">
                            <i class="fas fa-drum"></i>
                            <span>Tempo: <span id="project-tempo-value">{{ project.tempo }}</span> BPM</span>
                            {% if current_user.id == project.owner_id %}
                            <button id="edit-tempo-btn" class="vision-btn vision-btn-sm" title="Edit tempo">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                        </div>

                        <!-- Like button -->
                        <button id="like-button" class="vision-btn {% if is_liked %}liked{% endif %}"
                            title="{% if is_liked %}Unlike{% else %}Like{% endif %}">
                            <i class="fas {% if is_liked %}fa-heart{% else %}fa-heart{% endif %}"></i>
                            <span id="likes-count">{{ project.likes|length }}</span>
                        </button>

                        <!-- Play button will be dynamically added here by JavaScript -->
                        <div class="" id="play-button-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimized Compact Tools Layout -->
        <div class="tools-container">
            <!-- File Upload Section - Compact and Optimized -->
            <div class="upload-section">
                <div class="vision-glass-card file-upload-card fade-in">
                    <div class="file-upload-header modern-header">
                        <div class="header-icon"><i class="fas fa-music"></i></div>
                        <h3 class="mb-0">Add Track</h3>
                    </div>
                    <div class="file-upload-content p-3">
                        <form action="/projects/{{ project.id }}/upload-audio" method="post"
                            enctype="multipart/form-data" class="audio-upload-form" id="audio-upload-form">
                            <!-- Streamlined Layout -->
                            <div class="vertical-upload-layout">
                                <!-- File Selection & Submit -->
                                <div class="file-input-area">
                                    <div class="file-input-wrapper">
                                        <div class="compact-file-input">
                                            <label for="audio-file" class="custom-file-upload">
                                                <i class="fas fa-file-audio"></i> Choose File
                                            </label>
                                            <input type="file" id="audio-file" name="file" class="hidden-file-input"
                                                accept=".mp3,.wav,.ogg,.flac,.m4a" required>
                                            <span id="file-name" class="selected-file-name">No file selected</span>
                                        </div>
                                        <button type="submit" id="generate-midi-btn"
                                            class="vision-btn vision-btn-primary">
                                            <i class="fas fa-magic"></i> Generate
                                        </button>
                                    </div>
                                </div>

                                <!-- Разделитель между загрузкой и созданием пустой табы -->
                                <div class="separator">
                                    <span>OR</span>
                                </div>

                                <!-- Кнопка для создания пустой табулатуры -->
                                <div class="create-empty-tab-area">
                                    <button id="create-empty-tab-btn" type="button"
                                        class="vision-btn vision-btn-secondary">
                                        <i class="fas fa-file-alt"></i> Create Empty Tab
                                    </button>
                                </div>


                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Optimized Comments Section -->
            <div class="comments-section">
                <div class="vision-glass-card comments-card fade-in">
                    <div class="comments-header d-flex justify-content-between align-items-center modern-header">
                        <div class="header-icon"><i class="fas fa-comments"></i></div>
                        <h3 class="mb-0">Comments</h3>

                    </div>
                    <div class="comments-integrated-container">
                        <div class="comments-list compact-comments fill-height" id="comments-list">
                            <!-- Comments will be displayed here -->
                            <div class="text-center py-2" id="comments-loading"></div>
                            <div class="no-comments text-center py-2 d-none" id="no-comments"></div>
                        </div>
                        <div class="comment-form compact-form">
                            <div class="comment-input-group">
                                <textarea id="comment-text" class="form-control"
                                    placeholder="Write a comment..."></textarea>
                                <button id="send-comment" class="vision-btn vision-btn-primary send-comment-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sequencer Layout -->
    <div class="row sequencer-row">
        <!-- Left sidebar - Tracks column -->
        <div class="col-3 col-sm-3 col-md-3 tracks-column">
            <div class="vision-glass-card tracks-panel fade-in">
                <div class="panel-header">
                    <h3>Tracks</h3>
                </div>

                <!-- Tracks header -->
                <div class="tracks-header-placeholder mb-3">
                    <!-- Пустое пространство для выравнивания -->
                </div>
                <div id="upload-progress" class="progress mt-3 d-none">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="upload-message" class="mt-2 text-center"></div>

                <!-- Track list -->
                <div class="tracks-list" id="tracks-list">
                    {% if midi_files %}
                    {% for midi in midi_files %}
                    <div class="track-item {% if loop.first %}active{% endif %}" data-midi-id="{{ midi.id }}"
                        data-track-index="{{ loop.index0 }}">
                        <div class="track-info">
                            <div class="track-name-container">
                                <i class="fas fa-music track-icon"></i>
                                <span class="track-name">{{ midi.original_filename }}</span>
                            </div>
                            <div class="track-length">
                                <span class="track-duration">{{ midi.created_at.strftime('%H:%M') }}</span>
                            </div>

                        </div>

                        <div class="track-actions">
                            <a href="/projects/{{ project.id }}/midi/{{ midi.id }}"
                                class="vision-btn vision-btn-sm vision-btn-secondary">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <button class="btn-delete-midi vision-btn vision-btn-sm vision-btn-danger"
                                data-midi-id="{{ midi.id }}" data-project-id="{{ project.id }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="no-tracks-message">
                        <p>No tracks available.</p>
                        <p>Upload an audio file to create a track.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right side - Main workspace -->
        <div class="col-9 col-sm-9 col-md-9 workspace-column">
            <div class="vision-glass-card workspace-panel fade-in">
                <div class="panel-header workspace-header">
                    <h3>Tabulature</h3>
                </div>

                <!-- Удалено пустое пространство -->

                <!-- Sequencer grid area -->
                <div class="sequencer-grid">
                    <!-- Таймлайн удален -->

                    <div class="tracks-display" id="tracks-display">
                        {% if midi_files %}
                        {% for midi in midi_files %}
                        <div class="track-row" data-midi-id="{{ midi.id }}">

                            <div class="track-tablature" id="track-tablature-{{ midi.id }}">
                                {% if midi.tablatures and midi.tablatures[0].tab_text %}
                                <div class="tablature-content" data-tab-text='{{ midi.tablatures[0].tab_text }}'>
                                </div>
                                {% else %}
                                <div class="empty-tablature">No tablature available</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-tracks-placeholder">
                            <p>No tracks available</p>
                            <p>Upload an audio file to create tracks</p>
                        </div>
                        {% endif %}
                    </div>
                    <!-- Элементы управления зумом удалены -->
                </div>
            </div>
        </div>
    </div>

    <!-- Комментарии перенесены в компактную сетку выше -->
</div>


<style>
    /* Project header styling */
    .project-header-card {
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(12px);
        margin-bottom: 1.5rem;
    }

    .project-header-content {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .project-title-section {
        flex: 1;
        min-width: 300px;
    }

    .project-title {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .project-author {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .project-date {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .project-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

    .control-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
    }

    .project-tempo {
        font-weight: 500;
    }

    /* Base card styling */
    .vision-glass-card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .tracks-column,
    .workspace-column {
        margin-bottom: 20px;
    }

    .sequencer-row,
    .comments-section {
        margin-right: 0;
        margin-left: 0;
    }

    /* Project Header Styles */
    .project-header-card {
        padding: 20px 30px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
    }

    .project-title {
        font-size: 2rem;
        margin: 0;
        padding: 0;
        color: var(--primary-color);
    }

    .project-meta {
        padding-top: 10px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .header-main-row {
        padding: 10px 0;
    }

    /* File Upload Styles */
    .file-upload-card {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .file-upload-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.1);
    }

    .file-upload-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--primary-color);
    }

    .file-upload-content {
        padding: 15px;
        flex-grow: 1;
        overflow-y: auto;
    }

    .audio-input-section {
        padding: 15px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .project-meta {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .project-meta a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .project-meta a:hover {
        text-decoration: underline;
    }

    .project-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .likes-section {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #like-button {
        display: flex;
        align-items: center;
        gap: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: #ffffff;
        padding: 8px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    #like-button:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
    }

    #like-button.liked {
        background: rgba(255, 99, 71, 0.3);
        border-color: rgba(255, 99, 71, 0.5);
        color: #ff6347;
    }

    #like-button.liked i {
        color: #ff6347;
    }

    #like-button.liked:hover {
        background: rgba(255, 99, 71, 0.4);
    }

    .view-likes-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 5px 12px;
        white-space: nowrap;
        width: 80px;
        font-size: 0.85rem;
    }

    .view-likes-text {
        font-size: 0.85rem;
    }

    .project-section {
        margin-bottom: 30px;
    }

    .project-section h3 {
        font-size: 1.3rem;
        margin-bottom: 15px;
        color: var(--primary-color);
    }

    /* Стили для компонента комментариев */
    .comments-card {
        padding: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .comments-header {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    .comments-header h3 {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.3rem;
    }

    .comments-list {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 15px;
    }

    .comment-item {
        padding: 15px;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        border-left: 3px solid var(--primary-color);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        align-items: center;
    }

    .comment-author-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .comment-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
    }

    .avatar-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 100%;
        height: 100%;
        background-color: rgba(var(--primary-color-rgb), 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--primary-color);
        font-size: 18px;
    }

    .comment-author {
        font-weight: bold;
        color: var(--primary-color);
    }

    .comment-date {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Стили для отображения темпа */
    .project-tempo {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.08);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-flex;
    }

    .project-tempo i {
        color: var(--accent-color);
    }

    #project-tempo-value {
        font-weight: bold;
        color: var(--primary-text-color);
    }

    #edit-tempo-btn {
        padding: 2px 6px;
        font-size: 0.8rem;
        margin-left: 8px;
    }

    .tempo-edit-form {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tempo-edit-form input {
        width: 60px;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--primary-text-color);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .comment-content {
        color: var(--text-color);
        word-break: break-word;
    }

    .comment-form {
        margin-top: auto;
    }

    .comment-form textarea {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        border-radius: 8px;
        padding: 10px;
        resize: none;
        min-height: 80px;
    }

    .comment-form textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
    }

    /* Стили для работы с аудио и MIDI */
    /* Sequencer Layout Styles */
    .sequencer-row {
        display: flex;
        flex-wrap: nowrap;
        margin-right: 0;
        margin-left: 0;
    }

    .tracks-column,
    .workspace-column {
        padding-right: 10px;
        padding-left: 10px;
    }

    .tracks-panel,
    .workspace-panel {
        height: 100%;
        min-height: 500px;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.1);
    }

    #generate-midi-btn {
        height: 100%;
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }

    /* Tracks Panel */
    .tracks-list {
        overflow-y: auto;
        flex-grow: 1;
    }

    /* Связываем скроллинг дорожек и табулатур */
    .tracks-display {
        overflow-y: hidden;
        overflow-x: hidden;
        scrollbar-width: thin;
    }

    .audio-upload-section {
        background: rgba(0, 0, 0, 0.05);
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .track-item {
        padding: 10px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: background 0.2s ease;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .track-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .track-item.active {
        background: rgba(var(--primary-color-rgb), 0.15);
        border-left: 3px solid var(--primary-color);
    }

    .track-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .track-name-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .track-icon {
        color: var(--primary-color);
    }

    .track-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }

    .track-length {
        display: flex;
        align-items: center;
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    .track-actions {
        display: flex;
        justify-content: flex-end;
        gap: 5px;
    }

    .no-tracks-message {
        padding: 20px;
        text-align: center;
        color: var(--text-secondary);
    }

    /* Workspace Panel */
    .workspace-panel>div:not(.panel-header) {}

    /* Transport Controls */
    .filters-panel {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 16px 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .filters-header {
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 10px;
    }

    .filters-header h4 {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    .filters-content {
        padding: 5px;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
    }

    .filter-group {
        flex: 1;
        min-width: 250px;
    }

    .filter-group label {
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
        color: var(--text-primary);
    }

    /* Sequencer Grid */
    .sequencer-grid {
        position: relative;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
        height: calc(100% - 80px);
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    .timeline {
        height: 30px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .timeline-scale {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
    }

    .time-marker {
        position: absolute;
        height: 100%;
        width: 1px;
        background: rgba(255, 255, 255, 0.2);
    }

    .time-marker::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: -2px;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 50%;
    }

    .time-label {
        position: absolute;
        top: 3px;
        left: 4px;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.6);
        font-family: monospace;
    }

    .track-row {
        display: flex;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        align-items: center;
        height: 200px;
        position: relative;
    }

    .track-handle {
        width: 30px;
        background: rgba(0, 0, 0, 0.15);
        border-right: 1px solid var(--border-color);
        position: sticky;
        left: 0;
        z-index: 5;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .track-indicator {
        width: 10px;
        height: 10px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .track-row.hover .track-handle {
        background: rgba(var(--primary-color-rgb), 0.1);
    }

    .track-row.hover .track-indicator,
    .track-row.selected .track-indicator {
        background: var(--primary-color);
        box-shadow: 0 0 5px var(--primary-color);
    }

    .track-row.selected {
        background: rgba(var(--primary-color-rgb), 0.05);
    }

    .track-tablature {
        flex: 1;
        padding: 1px;
        overflow-x: auto;
        overflow-y: hidden;
        position: relative;
        max-width: 100%;
        display: flex;
        align-items: center;
        height: 100%;
    }

    .tablature-content {
        width: 100%;
        height: 100%;
        position: relative;
        overflow-y: hidden;
    }

    .empty-tablature {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        font-style: italic;
    }

    .no-tracks-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-secondary);
        text-align: center;
    }

    .view-controls {
        height: 40px;
        border-top: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
    }



    .filters-section {
        background: rgba(0, 0, 0, 0.05);
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
    }

    .tablature-container {
        flex-grow: 1;
        overflow: hidden;
        padding: 0 20px 20px 20px;
        position: relative;
    }

    .tablature-wrapper {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 20px;
        min-height: 300px;
        position: relative;
        overflow: auto;
        height: 100%;
    }

    .zoom-controls {
        position: absolute;
        bottom: 30px;
        right: 30px;
        z-index: 10;
        display: flex;
        gap: 5px;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px 10px;
        border-radius: 20px;
        backdrop-filter: blur(5px);
    }

    .no-tab-message {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--text-secondary);
        text-align: center;
    }

    /* Tab notation styles */
    .tab-notation {

        font-family: monospace;
        white-space: pre;
        background: rgba(0, 0, 0, 0.2);
        padding: 5px;
        border-radius: 5px;
        color: var(--text-primary);
        display: inline-block;
        min-width: 100%;
        box-sizing: border-box;
        transform-origin: top left;
        transition: transform 0.2s ease;
        overflow-x: auto;
        max-width: 100%;
        line-height: 1.8;
        font-size: 1.15em;
    }

    .tab-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .scroll-guide {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: rgba(255, 255, 255, 0.7);
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 0.8rem;
        transition: opacity 0.5s ease;
        opacity: 0;
        pointer-events: none;
    }

    .scroll-guide.visible {
        opacity: 1;
    }

    /* Form Range Styles - Sliders */
    .form-range {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: linear-gradient(to right, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.3));
        border-radius: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .form-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 22px;
        height: 22px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.15s ease;
    }

    .form-range::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }

    .form-range::-moz-range-thumb {
        width: 22px;
        height: 22px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.15s ease;
    }

    .form-range::-moz-range-thumb:hover {
        transform: scale(1.1);
    }

    /* Filters Section Styles */
    .filters-section {
        margin-top: 15px;
        padding: 22px;
        background: rgba(0, 0, 0, 0.12);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .filters-section h5 {
        color: var(--primary-color);
        margin-bottom: 15px;
        font-weight: 500;
    }

    .filter-group label {
        font-weight: 500;
        color: var(--text-secondary);
    }

    /* Zoom indicator styles */
    .zoom-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 50px;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .zoom-indicator.visible {
        opacity: 1;
    }

    /* Новые стили для компактной сетки */
    /* Оптимизированный контейнер инструментов */
    .tools-container {
        display: flex;
        margin-bottom: 1.5rem;
        gap: 1rem;
        height: 420px;
        /* Фиксированная высота для обоих фреймов */
    }

    .upload-section {
        width: 35%;
        height: 100%;
    }

    .comments-section {
        width: 65%;
        height: 100%;
    }

    .vision-glass-card.file-upload-card,
    .vision-glass-card.comments-card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Оптимизированные стили для загрузки файлов */
    .vertical-upload-layout {
        display: flex;
        flex-direction: column;
        gap: 15px;
        height: 100%;
    }

    .file-input-area {
        display: flex;
        flex-direction: column;
        margin-bottom: 5px;
    }

    .file-input-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
        height: 100%;
    }

    .file-input-wrapper .form-control {
        flex-grow: 1;
    }

    .filters-area {
        padding: 0;
        flex-grow: 1;
    }

    .filters-section {
        background: rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 12px;
        height: auto;
    }

    .filter-heading {
        margin-bottom: 10px;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .filter-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .slider-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .range-separator {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .range-values {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        margin-top: 5px;
        opacity: 0.8;
    }

    /* Новые стили для комментариев */
    .comments-integrated-container {
        display: flex;
        flex-direction: column;
        height: calc(100% - 50px);
        padding: 10px;
        overflow: hidden;
        /* Предотвращаем прокрутку контейнера */
    }

    .fill-height {
        flex-grow: 1;
        height: 100%;
        max-height: unset;
        overflow-y: auto;
        min-height: 180px;
        /* Увеличиваем минимальную высоту */
        padding-right: 5px;
        /* Небольшой отступ для полосы прокрутки */
    }

    .comment-input-group {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        margin-top: 10px;
    }

    .comment-input-group textarea {
        flex-grow: 1;
        min-height: 45px;
        resize: none;
        padding: 8px 12px;
    }

    .send-comment-btn {
        min-width: 40px;
        height: 40px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .comment-count {
        background-color: var(--primary-color);
        color: white;
        padding: 5px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
    }

    .modern-header {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background: linear-gradient(90deg, rgba(0, 80, 75, 0.2) 0%, rgba(0, 0, 0, 0.05) 100%);
        display: flex;
        align-items: center;
    }

    .header-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary-color);
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .comments-header {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .tools-container {
            flex-direction: column;
        }

        .upload-section,
        .comments-section {
            width: 100%;
        }

        .comments-section {
            margin-top: 1rem;
        }

        .streamlined-upload-grid {
            grid-template-columns: 1fr;
        }

        .file-input-wrapper {
            flex-direction: row;
        }

        .file-input-wrapper .form-control {
            flex-grow: 1;
        }
    }

    /* Стили для компактного инпута файла */
    .compact-file-input {
        display: flex;
        align-items: center;
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .custom-file-upload {
        background: var(--primary-color);
        color: white;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.9rem;
        margin: 0;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
    }

    .custom-file-upload i {
        margin-right: 5px;
    }

    .hidden-file-input {
        display: none;
    }

    .selected-file-name {
        margin-left: 10px;
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }

    /* Circle buttons for zoom controls */
    .vision-btn-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        transition: all 0.2s ease;
    }

    .vision-btn-circle:hover {
        background: rgba(0, 0, 0, 0.6);
        transform: scale(1.1);
    }

    .audio-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .audio-input-group input {
        flex: 1;
    }

    .midi-files-section {
        background: rgba(0, 0, 0, 0.05);
        padding: 20px;
        border-radius: 8px;
    }

    .midi-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        gap: 15px;
    }

    .midi-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .midi-name {
        font-weight: bold;
    }

    .midi-date {
        font-size: 0.8rem;
        color: var(--secondary-text-color);
    }

    /* Стили для разделителя */
    .separator {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 15px 0;
        color: var(--text-secondary);
    }

    .separator::before,
    .separator::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .separator::before {
        margin-right: 10px;
    }

    .separator::after {
        margin-left: 10px;
    }

    .create-empty-tab-area {
        display: flex;
        justify-content: center;
        margin-bottom: 15px;
    }

    /* Стили для модального окна */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-header h3 {
        margin: 0;
        color: var(--text-primary);
    }

    .close-modal {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .midi-actions {
        display: flex;
        gap: 5px;
    }

    .midi-player-section {
        background: rgba(0, 0, 0, 0.05);
        padding: 20px;
        border-radius: 8px;
    }

    #midi-visualizer,
    #midi-visualizer-container {
        width: 100%;
        height: 300px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-top: 10px;
        background-color: rgba(0, 0, 0, 0.2);
    }
</style>

<!-- Tone.js для синтеза звуков -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>

<script src="/static/js/sequencer.js"></script>
<script src="/static/js/render-tab.js"></script>
<script src="/static/js/tab-websocket.js"></script>
<script src="/static/js/tab-player.js"></script>
<script>
    // Функция для работы с комментариями
    function setupComments() {
        console.log('Инициализация комментариев...')
        const projectId = window.location.pathname.split('/').pop()
        const commentsList = document.getElementById('comments-list')
        const commentText = document.getElementById('comment-text')
        const sendButton = document.getElementById('send-comment')
        const loadingElement = document.getElementById('comments-loading')
        const noCommentsElement = document.getElementById('no-comments')

        // Проверяем, что все элементы найдены
        console.log('commentsList:', commentsList)
        console.log('commentText:', commentText)
        console.log('sendButton:', sendButton)
        console.log('loadingElement:', loadingElement)
        console.log('noCommentsElement:', noCommentsElement)

        // Загрузка комментариев
        loadComments()

        // Обработчик отправки комментария
        sendButton.addEventListener('click', function () {
            console.log('Кнопка отправки нажата')
            sendComment()
        })

        // Также добавляем обработчик нажатия Enter в поле ввода
        commentText.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault() // Предотвращаем перенос строки
                sendComment()
            }
        })

        // Функция загрузки комментариев
        function loadComments() {
            fetch(`/projects/${projectId}/comments`)
                .then(response => response.json())
                .then(comments => {
                    loadingElement.classList.add('d-none')

                    if (comments.length === 0) {
                        noCommentsElement.classList.remove('d-none')
                        return
                    }

                    // Очищаем список комментариев (кроме элементов загрузки и "нет комментариев")
                    const commentItems = commentsList.querySelectorAll('.comment-item')
                    commentItems.forEach(item => item.remove())

                    // Добавляем комментарии
                    comments.forEach(comment => {
                        const commentElement = createCommentElement(comment)
                        // Вставляем перед элементом "нет комментариев"
                        commentsList.insertBefore(commentElement, noCommentsElement)
                    })
                })
                .catch(error => {
                    console.error('Ошибка при загрузке комментариев:', error)
                    loadingElement.classList.add('d-none')
                    noCommentsElement.classList.remove('d-none')
                    noCommentsElement.querySelector('p').textContent = 'Ошибка при загрузке комментариев'
                })
        }

        // Функция отправки комментария
        function sendComment() {
            console.log('Попытка отправить комментарий...')
            const content = commentText.value.trim()
            console.log('Содержание комментария:', content)

            if (!content) {
                console.log('Пустой комментарий, отмена отправки')
                return
            }

            // Блокируем кнопку отправки
            console.log('Блокируем кнопку отправки')
            sendButton.disabled = true
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...'

            // Отправляем запрос
            console.log('Отправляем запрос на сервер:', `/projects/${projectId}/comments`)
            const requestData = { content }
            console.log('Данные запроса:', requestData)

            fetch(`/projects/${projectId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    console.log('Получен ответ от сервера:', response.status)
                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`)
                    }
                    return response.json()
                })
                .then(comment => {
                    console.log('Получены данные комментария:', comment)
                    // Очищаем поле ввода
                    commentText.value = ''

                    // Скрываем сообщение "нет комментариев"
                    noCommentsElement.classList.add('d-none')

                    // Добавляем новый комментарий в список
                    console.log('Создаем элемент комментария')
                    const commentElement = createCommentElement(comment)
                    commentsList.insertBefore(commentElement, noCommentsElement)

                    // Прокручиваем к новому комментарию
                    commentElement.scrollIntoView({ behavior: 'smooth' })
                    console.log('Комментарий успешно добавлен')
                })
                .catch(error => {
                    console.error('Ошибка при отправке комментария:', error)
                    alert(`Ошибка при отправке комментария: ${error.message}. Пожалуйста, попробуйте еще раз.`)
                })
                .finally(() => {
                    // Разблокируем кнопку отправки
                    sendButton.disabled = false
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>'
                })
        }

        // Функция создания элемента комментария
        function createCommentElement(comment) {
            const commentElement = document.createElement('div')
            commentElement.className = 'comment-item'
            commentElement.dataset.id = comment.id

            // Форматируем дату
            const date = new Date(comment.created_at)
            const formattedDate = date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })

            // Получаем инициалы для аватарки
            const initial = comment.user.full_name.charAt(0).toUpperCase()

            // Формируем HTML для аватарки
            let avatarHtml = ''
            if (comment.user.avatar_url) {
                avatarHtml = `<img src="${comment.user.avatar_url}" alt="${comment.user.full_name}" class="avatar-image">`
            } else {
                avatarHtml = `<div class="avatar-placeholder"><span>${initial}</span></div>`
            }

            commentElement.innerHTML = `
                <div class="comment-header">
                    <div class="comment-author-info">
                        <div class="comment-avatar">${avatarHtml}</div>
                        <span class="comment-author">${comment.user.full_name}</span>
                    </div>
                    <span class="comment-date">${formattedDate}</span>
                </div>
                <div class="comment-content">${comment.content}</div>
            `

            return commentElement
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Загрузка необходимых библиотек для работы с MIDI
        const loadScripts = async () => {
            // Create a global object for Midi to prevent exports error
            window.globalThis = window

            try {
                // Use a modified version that's browser compatible
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script')
                    script.src = 'https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/dist/Midi.js'
                    script.onload = resolve
                    script.onerror = reject
                    document.head.appendChild(script)
                })
                console.log('MIDI library loaded successfully')

                // Initialize Tone.js after a user interaction to avoid warnings
                const initAudio = async () => {
                    try {
                        await Tone.start()
                        console.log('Audio context started successfully')
                    } catch (error) {
                        console.error('Error starting audio context:', error)
                    }
                }

                // Add a listener to the whole document for the first click
                const startAudio = () => {
                    initAudio()
                    document.removeEventListener('click', startAudio)
                }
                document.addEventListener('click', startAudio)

            } catch (error) {
                console.error('Error loading MIDI library:', error)
            }
        }

        loadScripts().then(() => {
            console.log('MIDI libraries loaded successfully')
        }).catch(error => {
            console.error('Error loading MIDI libraries:', error)
        })

        // Функционал лайков
        const likeButton = document.getElementById('like-button')
        const likesCountElement = document.getElementById('likes-count')

        if (likeButton && likesCountElement) {
            likeButton.addEventListener('click', async function () {
                // Показываем индикатор загрузки на кнопке
                const originalHTML = likeButton.innerHTML
                likeButton.disabled = true
                likeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'

                // Отправляем запрос на добавление/удаление лайка
                try {
                    const response = await fetch(`/projects/${projectId}/like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })

                    if (!response.ok) {
                        throw new Error('Failed to process like')
                    }

                    const data = await response.json()

                    // Обновляем состояние кнопки и счетчик лайков
                    if (data.action === 'liked') {
                        likeButton.classList.add('liked')
                        likeButton.title = 'Unlike'

                        // Показываем toast-уведомление с высокой контрастностью
                        window.toast.success('You liked this project', {
                            duration: 3000,
                            style: {
                                background: 'rgba(15, 25, 40, 0.97)', // Повышенная контрастность
                                color: '#ffffff',
                                borderColor: 'rgba(255, 99, 71, 0.8)'
                            }
                        })
                    } else {
                        likeButton.classList.remove('liked')
                        likeButton.title = 'Like'

                        // Показываем toast-уведомление с высокой контрастностью
                        window.toast.info('You unliked this project', {
                            duration: 3000,
                            style: {
                                background: 'rgba(15, 25, 40, 0.97)', // Повышенная контрастность
                                color: '#ffffff'
                            }
                        })
                    }

                    // Обновляем счетчик лайков
                    likesCountElement.textContent = data.likes_count

                    // Восстанавливаем внешний вид кнопки
                    likeButton.innerHTML = originalHTML
                    likeButton.disabled = false
                } catch (error) {
                    console.error('Error processing like:', error)
                    window.toast.error('An error occurred while processing your like', {
                        duration: 3000,
                        style: {
                            background: 'rgba(15, 25, 40, 0.97)', // Повышенная контрастность
                            color: '#ffffff'
                        }
                    })

                    // Восстанавливаем внешний вид кнопки в случае ошибки
                    likeButton.innerHTML = originalHTML
                    likeButton.disabled = false
                }
            })
        }

        // Обработчик формы загрузки аудио
        const audioForm = document.getElementById('audio-upload-form')
        if (audioForm) {
            audioForm.addEventListener('submit', async function (e) {
                e.preventDefault()

                const fileInput = document.getElementById('audio-file')
                const file = fileInput.files[0]

                if (!file) {
                    showUploadMessage('Пожалуйста, выберите аудиофайл', 'danger')
                    return
                }

                // Показать индикатор прогресса
                const progressBar = document.querySelector('#upload-progress')
                progressBar.classList.remove('d-none')
                progressBar.querySelector('.progress-bar').style.width = '0%'

                showUploadMessage('Загрузка и обработка аудиофайла...', 'info')

                const formData = new FormData()
                formData.append('file', file)

                try {
                    // Отправляем запрос на преобразование аудио в MIDI
                    const response = await fetch(`/projects/${projectId}/upload-audio`, {
                        method: 'POST',
                        body: formData
                    })

                    progressBar.querySelector('.progress-bar').style.width = '100%'

                    if (!response.ok) {
                        const errorData = await response.json()
                        throw new Error(errorData.error || 'Ошибка при обработке файла')
                    }

                    const data = await response.json()

                    // Обновляем список MIDI-файлов
                    showUploadMessage('MIDI-файл успешно создан!', 'success')
                    setTimeout(() => {
                        window.location.reload()
                    }, 1500)

                } catch (error) {
                    console.error('Ошибка:', error)
                    showUploadMessage(`Ошибка: ${error.message}`, 'danger')
                    progressBar.classList.add('d-none')
                }
            })
        }

        // Функция для отображения сообщений
        function showUploadMessage(message, type) {
            const messageElement = document.getElementById('upload-message')
            messageElement.textContent = message
            messageElement.className = `mt-2 text-center alert alert-${type}`
        }



        // Get project ID from URL
        const projectId = window.location.pathname.split('/').pop()

        // Обработчики для удаления MIDI-файлов
        document.querySelectorAll('.btn-delete-midi').forEach(button => {
            button.addEventListener('click', async function () {
                if (!confirm('Вы уверены, что хотите удалить этот MIDI-файл?')) {
                    return
                }

                const midiId = this.getAttribute('data-midi-id')
                const projectId = this.getAttribute('data-project-id')

                try {
                    const response = await fetch(`/projects/${projectId}/midi/${midiId}/delete`, {
                        method: 'POST'
                    })

                    if (!response.ok) {
                        throw new Error('Ошибка при удалении файла')
                    }

                    // Удаляем элемент из DOM
                    const midiItem = this.closest('.midi-file-item')
                    if (midiItem) {
                        midiItem.remove()
                    }

                    // Если файлов не осталось, показываем сообщение
                    const midiList = document.getElementById('midi-files-list')
                    if (!midiList.querySelector('.midi-file-item')) {
                        midiList.innerHTML = '<div class="text-muted text-center"><p>Нет загруженных MIDI-файлов. Загрузите аудиофайл для преобразования в MIDI.</p></div>'
                    }

                } catch (error) {
                    console.error('Ошибка:', error)
                    alert(`Ошибка при удалении MIDI-файла: ${error.message}`)
                }
            })
        })


    })

    // Функция для работы с комментариями
    function setupComments() {
        console.log('Инициализация комментариев...')
        const projectId = window.location.pathname.split('/').pop()
        const commentsList = document.getElementById('comments-list')
        const commentText = document.getElementById('comment-text')
        const sendButton = document.getElementById('send-comment')
        const loadingElement = document.getElementById('comments-loading')
        const noCommentsElement = document.getElementById('no-comments')

        // Проверяем, что все элементы найдены
        console.log('commentsList:', commentsList)
        console.log('commentText:', commentText)
        console.log('sendButton:', sendButton)
        console.log('loadingElement:', loadingElement)
        console.log('noCommentsElement:', noCommentsElement)

        // Загрузка комментариев
        loadComments()

        // Обработчик отправки комментария
        sendButton.addEventListener('click', function () {
            console.log('Кнопка отправки нажата')
            sendComment()
        })

        // Также добавляем обработчик нажатия Enter в поле ввода
        commentText.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault() // Предотвращаем перенос строки
                sendComment()
            }
        })

        // Функция загрузки комментариев
        function loadComments() {
            fetch(`/projects/${projectId}/comments`)
                .then(response => response.json())
                .then(comments => {
                    loadingElement.classList.add('d-none')

                    if (comments.length === 0) {
                        noCommentsElement.classList.remove('d-none')
                        return
                    }

                    // Очищаем список комментариев (кроме элементов загрузки и "нет комментариев")
                    const commentItems = commentsList.querySelectorAll('.comment-item')
                    commentItems.forEach(item => item.remove())

                    // Добавляем комментарии
                    comments.forEach(comment => {
                        const commentElement = createCommentElement(comment)
                        // Вставляем перед элементом "нет комментариев"
                        commentsList.insertBefore(commentElement, noCommentsElement)
                    })
                })
                .catch(error => {
                    console.error('Ошибка при загрузке комментариев:', error)
                    loadingElement.classList.add('d-none')
                    noCommentsElement.classList.remove('d-none')
                    noCommentsElement.querySelector('p').textContent = 'Ошибка при загрузке комментариев'
                })
        }

        // Функция отправки комментария
        function sendComment() {
            console.log('Попытка отправить комментарий...')
            const content = commentText.value.trim()
            console.log('Содержание комментария:', content)

            if (!content) {
                console.log('Пустой комментарий, отмена отправки')
                return
            }

            // Блокируем кнопку отправки
            console.log('Блокируем кнопку отправки')
            sendButton.disabled = true
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...'

            // Отправляем запрос
            console.log('Отправляем запрос на сервер:', `/projects/${projectId}/comments`)
            const requestData = { content }
            console.log('Данные запроса:', requestData)

            fetch(`/projects/${projectId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    console.log('Получен ответ от сервера:', response.status)
                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`)
                    }
                    return response.json()
                })
                .then(comment => {
                    console.log('Получены данные комментария:', comment)
                    // Очищаем поле ввода
                    commentText.value = ''

                    // Скрываем сообщение "нет комментариев"
                    noCommentsElement.classList.add('d-none')

                    // Добавляем новый комментарий в список
                    console.log('Создаем элемент комментария')
                    const commentElement = createCommentElement(comment)
                    commentsList.insertBefore(commentElement, noCommentsElement)

                    // Прокручиваем к новому комментарию
                    commentElement.scrollIntoView({ behavior: 'smooth' })
                    console.log('Комментарий успешно добавлен')
                })
                .catch(error => {
                    console.error('Ошибка при отправке комментария:', error)
                    alert(`Ошибка при отправке комментария: ${error.message}. Пожалуйста, попробуйте еще раз.`)
                })
                .finally(() => {
                    // Разблокируем кнопку отправки
                    sendButton.disabled = false
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>'
                })
        }

        // Функция создания элемента комментария
        function createCommentElement(comment) {
            const commentElement = document.createElement('div')
            commentElement.className = 'comment-item'
            commentElement.dataset.id = comment.id

            // Форматируем дату
            const date = new Date(comment.created_at)
            const formattedDate = date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })

            // Получаем инициалы для аватарки
            const initial = comment.user.full_name.charAt(0).toUpperCase()

            // Формируем HTML для аватарки
            let avatarHtml = ''
            if (comment.user.avatar_url) {
                avatarHtml = `<img src="${comment.user.avatar_url}" alt="${comment.user.full_name}" class="avatar-image">`
            } else {
                avatarHtml = `<div class="avatar-placeholder"><span>${initial}</span></div>`
            }

            commentElement.innerHTML = `
                <div class="comment-header">
                    <div class="comment-author-info">
                        <div class="comment-avatar">${avatarHtml}</div>
                        <span class="comment-author">${comment.user.full_name}</span>
                    </div>
                    <span class="comment-date">${formattedDate}</span>
                </div>
                <div class="comment-content">${comment.content}</div>
            `

            return commentElement
        }
    }

    // Функция для настройки красивого выбора файла
    function setupFileInput() {
        const fileInput = document.getElementById('audio-file')
        const fileNameDisplay = document.getElementById('file-name')

        if (fileInput && fileNameDisplay) {
            fileInput.addEventListener('change', function () {
                if (this.files && this.files.length > 0) {
                    const fileName = this.files[0].name
                    fileNameDisplay.textContent = fileName
                } else {
                    fileNameDisplay.textContent = 'No file selected'
                }
            })
        }
    }

    // Функция для редактирования темпа проекта
    function setupTempoEdit() {
        const editBtn = document.getElementById('edit-tempo-btn')
        if (!editBtn) return

        const tempoContainer = document.querySelector('.project-tempo')
        const tempoValueElement = document.getElementById('project-tempo-value')
        const projectId = window.location.pathname.split('/').pop()

        editBtn.addEventListener('click', function () {
            const currentTempo = tempoValueElement.textContent.trim()

            // Создаем форму редактирования
            const form = document.createElement('form')
            form.className = 'tempo-edit-form'
            form.innerHTML = `
                <input type="number" id="tempo-input" value="${currentTempo}" min="20" max="300" required>
                <button type="submit" class="vision-btn vision-btn-sm"><i class="fas fa-check"></i></button>
                <button type="button" class="vision-btn vision-btn-sm" id="cancel-tempo-edit"><i class="fas fa-times"></i></button>
            `

            // Заменяем отображение темпа на форму
            const oldContent = tempoContainer.innerHTML
            tempoContainer.innerHTML = ''
            tempoContainer.appendChild(form)
            document.getElementById('tempo-input').focus()

            // Обработчик отмены редактирования
            document.getElementById('cancel-tempo-edit').addEventListener('click', function () {
                tempoContainer.innerHTML = oldContent
            })

            // Обработчик отправки формы
            form.addEventListener('submit', async function (e) {
                e.preventDefault()
                const newTempo = document.getElementById('tempo-input').value

                try {
                    const response = await fetch(`/projects/${projectId}/update-tempo`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ tempo: newTempo })
                    })

                    if (response.ok) {
                        const result = await response.json()

                        // Обновляем отображение
                        tempoContainer.innerHTML = oldContent
                        tempoValueElement.textContent = newTempo

                        // Уведомляем пользователя
                        showUploadMessage('Темп проекта успешно обновлен', 'success')
                    } else {
                        throw new Error('Ошибка при обновлении темпа')
                    }
                } catch (error) {
                    console.error('Ошибка:', error)
                    showUploadMessage('Не удалось обновить темп проекта', 'error')
                    tempoContainer.innerHTML = oldContent
                }
            })
        })
    }

    // Add the missing setupAudioUpload function
    function setupAudioUpload() {
        const audioForm = document.getElementById('audio-upload-form')
        if (audioForm) {
            audioForm.addEventListener('submit', async function (e) {
                e.preventDefault()

                const fileInput = document.getElementById('audio-file')
                const file = fileInput.files[0]

                if (!file) {
                    showUploadMessage('Пожалуйста, выберите аудиофайл', 'danger')
                    return
                }

                // Показать индикатор прогресса
                const progressBar = document.querySelector('#upload-progress')
                progressBar.classList.remove('d-none')
                progressBar.querySelector('.progress-bar').style.width = '0%'

                showUploadMessage('Загрузка и обработка аудиофайла...', 'info')

                const formData = new FormData()
                formData.append('file', file)

                try {
                    const projectId = window.location.pathname.split('/')[2]
                    // Отправляем запрос на преобразование аудио в MIDI
                    const response = await fetch(`/projects/${projectId}/upload-audio`, {
                        method: 'POST',
                        body: formData
                    })

                    progressBar.querySelector('.progress-bar').style.width = '100%'

                    if (!response.ok) {
                        const errorData = await response.json()
                        throw new Error(errorData.error || 'Ошибка при обработке файла')
                    }

                    const data = await response.json()

                    // Обновляем список MIDI-файлов
                    showUploadMessage('MIDI-файл успешно создан!', 'success')
                    setTimeout(() => {
                        window.location.reload()
                    }, 1500)

                } catch (error) {
                    console.error('Ошибка:', error)
                    showUploadMessage(`Ошибка: ${error.message}`, 'danger')
                    progressBar.classList.add('d-none')
                }
            })
        }
    }

    // Function to handle MIDI file actions (delete, play, etc)
    function setupMidiFileActions() {
        // Get all delete MIDI buttons
        const deleteButtons = document.querySelectorAll('.btn-delete-midi')

        deleteButtons.forEach(button => {
            button.addEventListener('click', async function () {
                const midiId = this.getAttribute('data-midi-id')
                const projectId = this.getAttribute('data-project-id')

                if (!confirm('Вы уверены, что хотите удалить этот MIDI файл и связанную табулатуру?')) {
                    return
                }

                try {
                    const response = await fetch(`/projects/${projectId}/midi/${midiId}`, {
                        method: 'DELETE'
                    })

                    if (response.ok) {
                        // Remove the track from DOM or reload page
                        const trackItem = this.closest('.track-item')
                        if (trackItem) {
                            trackItem.remove()

                            // Also remove related tablature
                            const tablature = document.querySelector(`.track-row[data-midi-id="${midiId}"]`)
                            if (tablature) {
                                tablature.remove()
                            }

                            // Show success message
                            window.toast.success('MIDI файл успешно удален', {
                                duration: 3000
                            })
                        } else {
                            // If DOM element not found, reload the page
                            window.location.reload()
                        }
                    } else {
                        throw new Error('Failed to delete MIDI file')
                    }
                } catch (error) {
                    console.error('Error deleting MIDI file:', error)
                    window.toast.error('Ошибка при удалении MIDI файла', {
                        duration: 3000
                    })
                }
            })
        })
    }

    // Initialization when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Setup file input display
        setupFileInput()
        // Initialize audio upload functionality
        setupAudioUpload()
        // Setup tempo editing
        setupTempoEdit()

        // Define the missing setupMidiFileActions function
        setupMidiFileActions()
        setupLikeButton()
        setupComments() // Инициализация комментариев
    })

    // Вызываем setupComments сразу, чтобы не ждать загрузки DOM
    // Это нужно, если скрипт загружается после формирования DOM
    setTimeout(setupComments, 100)

    // Функция для работы с пустыми табулатурами
    function setupEmptyTabCreation() {
        const createEmptyTabBtn = document.getElementById('create-empty-tab-btn')
        const modal = document.getElementById('empty-tab-modal')
        const closeBtn = modal.querySelector('.close-modal')
        const cancelBtn = document.getElementById('cancel-create-tab')
        const confirmBtn = document.getElementById('confirm-create-tab')
        const form = document.getElementById('empty-tab-form')

        // Открыть модальное окно
        createEmptyTabBtn.addEventListener('click', function () {
            modal.classList.add('show')
        })

        // Закрыть модальное окно (разные способы)
        function closeModal() {
            modal.classList.remove('show')
        }

        closeBtn.addEventListener('click', closeModal)
        cancelBtn.addEventListener('click', closeModal)

        // Обработка подтверждения создания табулатуры
        confirmBtn.addEventListener('click', async function () {
            // Проверка валидности формы
            const tabName = document.getElementById('tab-name').value
            const tabWidth = document.getElementById('tab-width').value

            if (!tabName) {
                showUploadMessage('Please enter a name for your tab', 'error')
                return
            }

            // Показываем индикатор загрузки
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...'
            confirmBtn.disabled = true

            try {
                // Получаем данные формы
                const formData = new FormData()
                formData.append('midi_name', tabName)
                formData.append('tab_width', tabWidth)

                // Отправляем запрос на создание пустой табулатуры
                const projectId = window.location.pathname.split('/').pop()
                const response = await fetch(`/projects/${projectId}/create-empty-tab`, {
                    method: 'POST',
                    body: formData
                })

                if (response.ok) {
                    // Успешно создана табулатура
                    showUploadMessage('Empty tab created successfully!', 'success')
                    // Перезагружаем страницу для отображения новой табулатуры
                    setTimeout(() => {
                        window.location.reload()
                    }, 1000)
                } else {
                    // Ошибка при создании
                    const result = await response.json()
                    showUploadMessage(`Error: ${result.error || 'Could not create empty tab'}`, 'error')
                }
            } catch (error) {
                showUploadMessage(`Error: ${error.message}`, 'error')
            } finally {
                // Восстанавливаем кнопку
                confirmBtn.innerHTML = 'Create Tab'
                confirmBtn.disabled = false
                // Закрываем модальное окно
                closeModal()
            }
        })
    }

    // Инициализируем функционал создания пустой табулатуры
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('create-empty-tab-btn')) {
            console.log('Initializing empty tab creation...')
            setupEmptyTabCreation()
        }
    })

    // Для уверенности добавляем обработчик напрямую
    document.querySelector('#create-empty-tab-btn')?.addEventListener('click', function () {
        console.log('Create empty tab button clicked')
        document.getElementById('empty-tab-modal').classList.add('show')
    });
</script>

<!-- Модальное окно для создания пустой табулатуры -->
<div id="empty-tab-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Empty Tab</h3>
            <button type="button" class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="empty-tab-form">
                <div class="form-group mb-3">
                    <label for="tab-name">Tab Name</label>
                    <input type="text" id="tab-name" name="midi_name" class="vision-input" placeholder="My Tab"
                        required>
                </div>
                <div class="form-group mb-3">
                    <label for="tab-width">Tab Width</label>
                    <input type="number" id="tab-width" name="tab_width" class="vision-input" min="40" max="200"
                        value="80" required>
                    <small class="text-muted">Number of characters (40-200)</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="vision-btn vision-btn-secondary" id="cancel-create-tab">Cancel</button>
            <button type="button" class="vision-btn vision-btn-primary" id="confirm-create-tab">Create Tab</button>
        </div>
    </div>
</div>

{% endblock %}